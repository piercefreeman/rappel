{% extends "base.html" %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<section class="space-y-4">
    <a href="/" class="text-xs uppercase tracking-[0.4em] text-gray-500 transition hover:text-gray-300">&larr; Back to all workflows</a>
    <div class="space-y-2">
        <h1 class="text-3xl font-semibold tracking-tight text-white">{{ workflow.name }}</h1>
        <p class="text-sm text-gray-400">Workflow version #{{ workflow.id }}</p>
    </div>
    <dl class="grid gap-4 rounded-2xl border border-gray-900 bg-gray-900/40 p-6 sm:grid-cols-2">
        <div>
            <dt class="text-xs uppercase tracking-[0.4em] text-gray-500">Version ID</dt>
            <dd class="text-lg font-semibold text-white">{{ workflow.id }}</dd>
        </div>
        <div>
            <dt class="text-xs uppercase tracking-[0.4em] text-gray-500">Created</dt>
            <dd class="text-lg font-semibold text-white">{{ workflow.created_at }}</dd>
        </div>
        <div>
            <dt class="text-xs uppercase tracking-[0.4em] text-gray-500">Hash</dt>
            <dd class="font-mono text-sm text-gray-200 break-all">{{ workflow.hash }}</dd>
        </div>
        <div>
            <dt class="text-xs uppercase tracking-[0.4em] text-gray-500">Execution</dt>
            <dd class="text-lg font-semibold text-white">{{ workflow.concurrency_label }}</dd>
        </div>
    </dl>
</section>

<section class="space-y-3">
    <div>
        <p class="text-xs uppercase tracking-[0.4em] text-gray-500">Visualization</p>
        <h2 class="text-2xl font-semibold text-white">DAG Layout</h2>
    </div>
    <div id="workflow-graph" class="relative min-h-[280px] overflow-hidden rounded-2xl border border-gray-900 bg-gradient-to-br from-gray-950 to-gray-900">
        <p id="graph-empty" class="p-6 text-sm text-gray-400">Workflow nodes will draw here once a DAG is registered.</p>
    </div>
</section>

<section class="space-y-3">
    <div>
        <p class="text-xs uppercase tracking-[0.4em] text-gray-500">Nodes</p>
        <h2 class="text-2xl font-semibold text-white">Workflow Steps</h2>
    </div>
    {% if has_nodes %}
        <div class="grid gap-4 lg:grid-cols-2">
            {% for node in nodes %}
                <div class="rounded-2xl border border-gray-900 bg-gray-900/40 p-5">
                    <div class="flex items-center justify-between">
                        <p class="text-lg font-semibold text-white">{{ node.id }}</p>
                        <span class="text-xs uppercase tracking-[0.4em] text-gray-500">{{ node.module }}</span>
                    </div>
                    <p class="text-sm text-gray-300">{{ node.action }}</p>
                    <div class="mt-4 space-y-2 text-sm text-gray-400">
                        <p><span class="font-semibold text-gray-300">Depends on:</span> {{ node.depends_on_display }}</p>
                        <p><span class="font-semibold text-gray-300">Waits for:</span> {{ node.waits_for_display }}</p>
                        <p><span class="font-semibold text-gray-300">Guard:</span> {{ node.guard }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="rounded-2xl border border-dashed border-gray-800 bg-gray-900/40 p-6 text-sm text-gray-400">
            This workflow has no DAG nodes.
        </div>
    {% endif %}
</section>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const graphData = {{ graph_data | json_encode | safe }};
  if (!graphData || !graphData.nodes || !graphData.nodes.length) {
    return;
  }
  const placeholder = document.getElementById('graph-empty');
  if (placeholder) {
    placeholder.remove();
  }
  const container = document.getElementById('workflow-graph');
  if (!container) {
    return;
  }
  const nodes = graphData.nodes;
  const padding = 32;
  const columnGap = 220;
  const rowGap = 140;
  const nodeWidth = 180;
  const nodeHeight = 90;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'absolute inset-0 h-full w-full pointer-events-none');
  container.appendChild(svg);
  const nodeMap = new Map(nodes.map((node) => [node.id, node]));
  const depthCache = new Map();
  const computeDepth = (nodeId, stack = new Set()) => {
    if (depthCache.has(nodeId)) {
      return depthCache.get(nodeId);
    }
    const node = nodeMap.get(nodeId);
    if (!node || !node.depends_on.length) {
      depthCache.set(nodeId, 0);
      return 0;
    }
    if (stack.has(nodeId)) {
      return 0;
    }
    stack.add(nodeId);
    let depth = 0;
    node.depends_on.forEach((dep) => {
      depth = Math.max(depth, computeDepth(dep, stack) + 1);
    });
    stack.delete(nodeId);
    depthCache.set(nodeId, depth);
    return depth;
  };
  const levels = [];
  nodes.forEach((node) => {
    const depth = computeDepth(node.id);
    if (!levels[depth]) {
      levels[depth] = [];
    }
    levels[depth].push(node);
  });
  const normalizedLevels = Array.from({ length: levels.length }, (_, index) => levels[index] || []);
  const positions = new Map();
  normalizedLevels.forEach((levelNodes, depth) => {
    levelNodes.forEach((node, index) => {
      const left = padding + depth * columnGap;
      const top = padding + index * rowGap;
      const el = document.createElement('div');
      el.className = 'absolute rounded-2xl border border-gray-800 bg-gray-950/80 px-4 py-3 shadow-lg';
      el.style.left = `${left}px`;
      el.style.top = `${top}px`;
      el.style.width = `${nodeWidth}px`;
      el.innerHTML = `
        <p class="text-[11px] font-mono uppercase tracking-wide text-gray-500">${node.id}</p>
        <p class="text-sm font-semibold text-white">${node.action}</p>
        <p class="text-xs text-gray-400">${node.module}</p>
      `;
      container.appendChild(el);
      positions.set(node.id, {
        x: left + nodeWidth / 2,
        y: top + nodeHeight / 2,
      });
    });
  });
  const rowCounts = normalizedLevels.map((level) => Math.max(level.length, 1));
  const maxRows = rowCounts.length ? Math.max(...rowCounts) : 1;
  const totalWidth = padding * 2 + Math.max(normalizedLevels.length - 1, 0) * columnGap + nodeWidth;
  const totalHeight = padding * 2 + (maxRows - 1) * rowGap + nodeHeight;
  container.style.height = `${Math.max(totalHeight, 240)}px`;
  svg.setAttribute('width', totalWidth);
  svg.setAttribute('height', Math.max(totalHeight, 240));
  nodes.forEach((node) => {
    node.depends_on.forEach((dependency) => {
      const start = positions.get(dependency);
      const end = positions.get(node.id);
      if (!start || !end) {
        return;
      }
      const connector = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const midX = (start.x + end.x) / 2;
      const d = `M${start.x},${start.y} C${midX},${start.y} ${midX},${end.y} ${end.x},${end.y}`;
      connector.setAttribute('d', d);
      connector.setAttribute('fill', 'none');
      connector.setAttribute('stroke', '#4b5563');
      connector.setAttribute('stroke-width', '2');
      connector.setAttribute('stroke-linecap', 'round');
      svg.appendChild(connector);
    });
  });
});
</script>
{% endblock scripts %}
